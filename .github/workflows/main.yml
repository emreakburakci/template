name: Otomatik Puanlama ve AI Hoca (Push Modu)

on: [push] # ARTIK HER PUSH İŞLEMİNDE ÇALIŞACAK

permissions:
  contents: write # Commit'e yorum yazabilmesi için yazma izni lazım

jobs:
  review:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    
    - name: Python Kurulumu
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Kütüphaneleri Yükle
      run: |
        pip install pytest google-generativeai

    # 1. Aşama: Mekanik Test (Kapı Bekçisi)
    # Test başarısız olursa süreç burada durur, öğrenci Kırmızı Çarpı görür.
    - name: Testleri Çalıştır
      id: test_step
      run: |
        pytest hesap-makinesi-odevi/test_main.py

    # 2. Aşama: AI Hoca (Sadece test geçerse çalışır)
    - name: AI Kod İncelemesi Yap
      if: success() 
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        python hesap-makinesi-odevi/ai_hoca.py > ai_feedback.txt
      
    # 3. Aşama: Yorumu COMMIT'e Yapıştır
    # PR olmadığı için direkt commit altına yorum atıyoruz.
    - name: Commit'e Yorum Yap
      if: success()
      uses: peter-evans/commit-comment@v3
      with:
        body-path: ai_feedback.txt